// jQuery tagEditor v1.0.12
// https://github.com/Pixabay/jQuery-tagEditor
!function(t){t.fn.tagEditorInput=function(){var e=" ",i=t(this),a=parseInt(i.css("fontSize")),l=t("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"}),r=function(){if(e!==(e=i.val())){l.html(e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var t=l.width()+a;20>t&&(t=20),t!=i.width()&&i.width(t)}};return l.insertAfter(i),i.bind("keyup keydown focus",r)},t.fn.tagEditor=function(e,a,l){function r(e){if(8==e.which||46==e.which||e.ctrlKey&&88==e.which){try{var a=getSelection(),l=t(a.getRangeAt(0).commonAncestorContainer)}catch(e){l=0}if(l&&l.hasClass("tag-editor")){var r=[],n=a.toString().split(l.prev().data("options").dregex);for(i=0;i<n.length;i++){var o=t.trim(n[i]);o&&r.push(o)}t(".tag-editor-tag",l).each(function(){~t.inArray(t(this).html(),r)&&t(this).closest("li").find(".tag-editor-delete").click()})}}}var n,o=t.extend({},t.fn.tagEditor.defaults,e),c=this;if(o.dregex=new RegExp("["+o.delimiter.replace("-","-")+"]","g"),"string"==typeof e){var s=[];return c.each(function(){var i=t(this),r=i.data("options"),n=i.next(".tag-editor");"getTags"==e?s.push({field:i[0],editor:n,tags:n.data("tags")}):"addTag"==e?(t('<li><div class="tag-editor-spacer">&nbsp;'+r.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(n).find(".tag-editor-tag").html('<input type="text" maxlength="'+r.maxLength+'">').addClass("active").find("input").val(a).blur(),l?t(".placeholder",n).remove():n.click()):"removeTag"==e?(t(".tag-editor-tag",n).filter(function(){return t(this).html()==a}).closest("li").find(".tag-editor-delete").click(),l||n.click()):"destroy"==e&&i.css("display",r.elDisplay).removeData("options").next(".tag-editor").remove()}),"getTags"==e?s:this}return window.getSelection&&t(document).off("keydown.tag-editor").on("keydown.tag-editor",r),c.each(function(){function e(){!o.placeholder||c.length||t(".deleted, .placeholder, input",d).length||d.append('<li class="placeholder"><div>'+o.placeholder+"</div></li>")}function a(i){var a=c.toString();c=t(".tag-editor-tag:not(.deleted)",d).map(function(e,i){var a=t.trim(t(this).hasClass("active")?t(this).find("input").val():t(i).text());return a?a:void 0}).get(),d.data("tags",c),r.val(c.join(o.delimiter[0])),i||a!=c.toString()&&o.onChange(r,d,c),e()}function l(e){var l=e.closest("li"),n=e.val().replace(/ +/," ").split(o.dregex),s=e.data("old_tag"),g=c.slice(0);for(i=0;i<n.length;i++)p=t.trim(n[i]).slice(0,o.maxLength),p&&(o.forceLowercase&&(p=p.toLowerCase()),p=o.beforeTagSave(r,d,g,s,p)||p,~t.inArray(p,g)&&t(".tag-editor-tag",d).each(function(){t(this).html()==p&&t(this).closest("li").remove()}),g.push(p),l.before('<li><div class="tag-editor-spacer">&nbsp;'+o.delimiter[0]+'</div><div class="tag-editor-tag">'+p+'</div><div class="tag-editor-delete"><i></i></div></li>'));e.attr("maxlength",o.maxLength).removeData("old_tag").val("").focus(),a()}var r=t(this),c=[],s=parseInt(r.attr("tabindex"));o.elDisplay=r.css("display"),r.css("display","none");var d=t("<ul "+(o.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(r);r.data("options",o),d.append('<li style="width:.1px">&nbsp;</li>'),s>0&&d.attr("tabindex",s).focus(function(){t(this).click()});var g='<li><div class="tag-editor-spacer">&nbsp;'+o.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';d.click(function(e,i){var a,l,r=99999;if(!window.getSelection||""==getSelection())return n=!0,t("input:focus",d).blur(),n?(n=!0,t(".placeholder",d).remove(),i&&i.length?l="before":t(".tag-editor-tag",d).each(function(){var n=t(this),o=n.offset(),c=o.left,s=o.top;e.pageY>=s&&e.pageY<=s+n.height()&&(e.pageX<c?(l="before",a=c-e.pageX):(l="after",a=e.pageX-c-n.width()),r>a&&(r=a,i=n))}),"before"==l?t(g).insertBefore(i.closest("li")).find(".tag-editor-tag").click():"after"==l?t(g).insertAfter(i.closest("li")).find(".tag-editor-tag").click():t(g).appendTo(d).find(".tag-editor-tag").click(),!1):!1}),d.on("click",".tag-editor-delete",function(){if(t(this).prev().hasClass("active"))return t(this).closest("li").find("input").caret(-1),!1;var i=t(this).closest("li"),l=i.find(".tag-editor-tag");return o.beforeTagDelete(r,d,c,l.html())===!1?!1:(l.addClass("deleted").animate({width:0},175,function(){i.remove(),e()}),a(),!1)}),o.clickDelete&&d.on("mousedown",".tag-editor-tag",function(i){if(i.ctrlKey||i.which>1){var l=t(this).closest("li"),n=l.find(".tag-editor-tag");return o.beforeTagDelete(r,d,c,n.html())===!1?!1:(n.addClass("deleted").animate({width:0},175,function(){l.remove(),e()}),a(),!1)}}),d.on("click",".tag-editor-tag",function(e){if(o.clickDelete&&(e.ctrlKey||e.which>1))return!1;if(!t(this).hasClass("active")){var i=t(this).html(),a=Math.abs((t(this).offset().left-e.pageX)/t(this).width()),l=parseInt(i.length*a),r=t(this).html('<input type="text" maxlength="'+o.maxLength+'" value="'+i+'">').addClass("active").find("input");if(r.data("old_tag",i).tagEditorInput().focus().caret(l),o.autocomplete){var n=t.extend({},o.autocomplete),c="select"in n?o.autocomplete.select:"";n.select=function(){c&&c(),setTimeout(function(){t(".active",d).find("input").focus()},20)},r.autocomplete(n)}}return!1}),d.on("blur","input",function(){var i=t(this),s=i.data("old_tag"),g=t.trim(i.val().replace(/ +/," ").replace(o.dregex,o.delimiter[0]));if(g){if(g.indexOf(o.delimiter[0])>=0)return void l(i);g!=s&&(o.forceLowercase&&(g=g.toLowerCase()),g=o.beforeTagSave(r,d,c,s,g)||g,t(".tag-editor-tag:not(.active)",d).each(function(){t(this).html()==g&&t(this).closest("li").remove()}))}else{if(s&&o.beforeTagDelete(r,d,c,s)===!1)return i.val(s).focus(),n=!1,void a();try{i.closest("li").remove()}catch(f){}s&&a()}i.parent().html(g).removeClass("active"),g!=s&&a(),e()});var f;d.on("paste","input",function(){t(this).removeAttr("maxlength"),f=t(this),setTimeout(function(){l(f)},30)});var h;d.on("keypress","input",function(e){o.delimiter.indexOf(String.fromCharCode(e.which))>=0&&(h=t(this),setTimeout(function(){l(h)},20))}),d.on("keydown","input",function(e){var i=t(this);if((37==e.which||!o.autocomplete&&38==e.which)&&!i.caret()||8==e.which&&!i.val()){var a=i.closest("li").prev("li").find(".tag-editor-tag");return a.length?a.click().find("input").caret(-1):i.val()&&t(g).insertBefore(i.closest("li")).find(".tag-editor-tag").click(),!1}if((39==e.which||!o.autocomplete&&40==e.which)&&i.caret()==i.val().length){var l=i.closest("li").next("li").find(".tag-editor-tag");return l.length?l.click().find("input").caret(0):i.val()&&d.click(),!1}if(9==e.which){if(e.shiftKey){var a=i.closest("li").prev("li").find(".tag-editor-tag");return a.length?a.click().find("input").caret(0):i.val()?t(g).insertBefore(i.closest("li")).find(".tag-editor-tag").click():s>0&&t("[tabindex="+(s-1)+"]").focus(),!1}var l=i.closest("li").next("li").find(".tag-editor-tag");if(l.length)l.click().find("input").caret(0);else if(i.val())d.click();else if(s>0)return;return!1}if(!(46!=e.which||t.trim(i.val())&&i.caret()!=i.val().length)){var l=i.closest("li").next("li").find(".tag-editor-tag");return l.length?l.click().find("input").caret(0):i.val()&&d.click(),!1}if(13==e.which)return d.trigger("click",[i.closest("li").next("li").find(".tag-editor-tag")]),!1;if(36!=e.which||i.caret()){if(35==e.which&&i.caret()==i.val().length)d.find(".tag-editor-tag").last().click();else if(27==e.which)return i.val(i.data("old_tag")?i.data("old_tag"):"").blur(),!1}else d.find(".tag-editor-tag").first().click()});var u=o.initialTags.length?o.initialTags:r.val().split(o.dregex);for(i=0;i<u.length;i++){var p=t.trim(u[i].replace(/ +/," "));p&&(o.forceLowercase&&(p=p.toLowerCase()),c.push(p),d.append('<li><div class="tag-editor-spacer">&nbsp;'+o.delimiter[0]+'</div><div class="tag-editor-tag">'+p+'</div><div class="tag-editor-delete"><i></i></div></li>'))}a(!0),o.sortable&&t.fn.sortable&&d.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){a()}})})},t.fn.tagEditor.defaults={initialTags:[],maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,clickDelete:!1,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);
